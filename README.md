# pg_search

The purpose of this project is to experiment with PostgreSQL full-text search. I have installed the Docker image for PG 16.x. And I will use data from my reading lists.


## Optimizing Full-Text Search 

GitHub Copilot generated these tips for optimizing full-text search in PostgreSQL:

1. **Use tsvector columns**: Store your searchable data in `tsvector` columns. This data type is optimized for full-text search operations.

2. **Use GIN indexes**: Create GIN (Generalized Inverted Index) indexes on your `tsvector` columns. GIN indexes are particularly efficient for full-text search operations.

3. **Use weights**: Assign weights to different parts of your `tsvector` data to influence the ranking of search results. You can use the `setweight` function to assign weights.

4. **Use text search configurations**: Use text search configurations to customize the behavior of full-text search operations. This includes defining dictionaries, parsers, and templates.

5. **Use triggers or generated columns**: If your `tsvector` data depends on other columns in your table, consider using triggers or generated columns to automatically update the `tsvector` data when the other columns change.

6. **Use the `@@` operator for search**: Use the `@@` operator to perform full-text search operations. This operator returns true if a `tsvector` matches a `tsquery`.

7. **Use the `ts_rank` and `ts_rank_cd` functions for ranking**: Use the `ts_rank` and `ts_rank_cd` functions to rank search results. These functions return a number that indicates how well a `tsvector` matches a `tsquery`.

8. **Use the `plainto_tsquery` and `to_tsquery` functions for query parsing**: Use the `plainto_tsquery` and `to_tsquery` functions to convert a string to a `tsquery`.

9. **Use the `ts_headline` function for result snippets**: Use the `ts_headline` function to generate a snippet of text that shows how a `tsvector` matches a `tsquery`.

10. **Use the `strip` function to remove HTML tags**: If your `tsvector` data includes HTML, use the `strip` function to remove the HTML tags before performing full-text search operations.

## Real-World Example

I asked GitHub Copilot to generate a real-world example of how to optimize full-text search in PostgreSQL. Here is the example it generated:

```sql
-- Generated by GitHub Copilot
--
-- Step 1: Create a function for the books table
CREATE OR REPLACE FUNCTION update_books_searchable() RETURNS TRIGGER AS $$
BEGIN
  NEW.searchable := to_tsvector('english', NEW.title || ' ' || NEW.title_full || ' ' || (SELECT name_first || ' ' || name_last FROM authors WHERE author_id = NEW.author_id));
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

-- Step 2: Create a trigger for the books table
CREATE TRIGGER update_books_searchable_trigger
BEFORE INSERT OR UPDATE ON books
FOR EACH ROW EXECUTE FUNCTION update_books_searchable();

-- Step 3: Create a function for the authors table
CREATE OR REPLACE FUNCTION update_authors_searchable() RETURNS TRIGGER AS $$
BEGIN
  UPDATE books
  SET searchable = to_tsvector('english', NEW.name_first || ' ' || NEW.name_last || ' ' || (SELECT title || ' ' || title_full FROM books WHERE author_id = NEW.author_id))
  WHERE author_id = NEW.author_id;
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

-- Step 4: Create a trigger for the authors table
CREATE TRIGGER update_authors_searchable_trigger
AFTER UPDATE ON authors
FOR EACH ROW EXECUTE FUNCTION update_authors_searchable();
```

## Updating Tags

Values for an array column are expressed as a string containing values in curly brackets.

```sql
begin;
update books set tags = '{Thriller,Legal,Crime,"Rene Ballard",kindle}' where book_id = 50;
commit;
```

## Commands

* db add-event         Adds an event to the database.
* db authors           Lists authors in the database.
* db book-status       Lists books with status pass as argument
* db build-searchable  Updates the searchable column for a book.
* db find-book         Finds a book by its book_id.
* db insert-books      Inserts one or more books in yml_input in the form of...
* db prepare           This function takes a flat yaml file containing book...
* db reindex           Rebuilds the idx_searchable_book index.
* db search            Full-text search for books and authors.
